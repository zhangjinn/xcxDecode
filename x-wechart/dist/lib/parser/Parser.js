"use strict";

//Parser.js
var Tokenizer = require('./Tokenizer.js');
var DomHandler = require('./DomHandler.js');
var trustAttrs = {
  align: true,
  alt: true,
  author: true,
  autoplay: true,
  class: true,
  color: true,
  colspan: true,
  controls: true,
  "data-src": true,
  dir: true,
  face: true,
  height: true,
  href: true,
  id: true,
  ignore: true,
  loop: true,
  muted: true,
  name: true,
  poster: true,
  rowspan: true,
  size: true,
  span: true,
  src: true,
  start: true,
  style: true,
  type: true,
  width: true
};
var voidTag = {
  area: true,
  base: true,
  basefont: true,
  br: true,
  col: true,
  circle: true,
  command: true,
  ellipse: true,
  embed: true,
  frame: true,
  hr: true,
  img: true,
  input: true,
  isindex: true,
  keygen: true,
  line: true,
  link: true,
  meta: true,
  param: true,
  path: true,
  polygon: true,
  polyline: true,
  rect: true,
  source: true,
  stop: true,
  track: true,
  use: true,
  wbr: true
};

function Parser(cbs, callback) {
  this._cbs = cbs;
  this._callback = callback;
  this._tagname = "";
  this._attribname = "";
  this._attribvalue = "";
  this._attribs = null;
  this._stack = [];
  this._tokenizer = new Tokenizer(this);
}
Parser.prototype.ontext = function (data) {
  this._cbs.ontext(data);
};
Parser.prototype.onopentagname = function (name) {
  name = name.toLowerCase();
  this._tagname = name;
  this._attribs = {
    style: ''
  };
  if (!voidTag[name]) this._stack.push(name);
};
Parser.prototype.onopentagend = function () {
  if (this._attribs) {
    this._cbs.onopentag(this._tagname, this._attribs);
    this._attribs = null;
  }
  if (voidTag[this._tagname]) this._cbs.onclosetag(this._tagname);
  this._tagname = "";
};
Parser.prototype.onclosetag = function (name) {
  name = name.toLowerCase();
  if (this._stack.length && !voidTag[name]) {
    var pos = this._stack.lastIndexOf(name);
    if (pos !== -1) {
      pos = this._stack.length - pos;
      while (pos--) {
        this._cbs.onclosetag(this._stack.pop());
      }
    } else if (name === "p") {
      this.onopentagname(name);
      this._closeCurrentTag();
    }
  } else if (name === "br" || name === "hr" || name === "p") {
    this.onopentagname(name);
    this._closeCurrentTag();
  }
};
Parser.prototype._closeCurrentTag = function () {
  var name = this._tagname;
  this.onopentagend();
  if (this._stack[this._stack.length - 1] === name) {
    this._cbs.onclosetag(name);
    this._stack.pop();
  }
};
Parser.prototype.onattribend = function () {
  this._attribvalue = this._attribvalue.replace(/&quot;/g, '"');
  if (this._attribs && trustAttrs[this._attribname]) {
    this._attribs[this._attribname] = this._attribvalue;
  }
  this._attribname = "";
  this._attribvalue = "";
};
Parser.prototype.onend = function () {
  for (var i = this._stack.length; i > 0; this._cbs.onclosetag(this._stack[--i])) {}
  this._callback({
    'nodes': this._cbs.nodes,
    'title': this._cbs.title,
    'imgList': this._cbs.imgList
  });
};
Parser.prototype.write = function (chunk) {
  this._tokenizer.parse(chunk);
};

function html2nodes(data, tagStyle) {
  return new Promise(function (resolve, reject) {
    try {
      var style = '';
      data = data.replace(/<style.*?>([\s\S]*?)<\/style>/gi, function () {
        style += arguments[1];
        return '';
      });
      var handler = new DomHandler(style, tagStyle);
      new Parser(handler, function (res) {
        return resolve(res);
      }).write(data);
    } catch (err) {
      return reject(err);
    }
  });
}
module.exports = html2nodes;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlBhcnNlci5qcyJdLCJuYW1lcyI6WyJUb2tlbml6ZXIiLCJyZXF1aXJlIiwiRG9tSGFuZGxlciIsInRydXN0QXR0cnMiLCJhbGlnbiIsImFsdCIsImF1dGhvciIsImF1dG9wbGF5IiwiY2xhc3MiLCJjb2xvciIsImNvbHNwYW4iLCJjb250cm9scyIsImRpciIsImZhY2UiLCJoZWlnaHQiLCJocmVmIiwiaWQiLCJpZ25vcmUiLCJsb29wIiwibXV0ZWQiLCJuYW1lIiwicG9zdGVyIiwicm93c3BhbiIsInNpemUiLCJzcGFuIiwic3JjIiwic3RhcnQiLCJzdHlsZSIsInR5cGUiLCJ3aWR0aCIsInZvaWRUYWciLCJhcmVhIiwiYmFzZSIsImJhc2Vmb250IiwiYnIiLCJjb2wiLCJjaXJjbGUiLCJjb21tYW5kIiwiZWxsaXBzZSIsImVtYmVkIiwiZnJhbWUiLCJociIsImltZyIsImlucHV0IiwiaXNpbmRleCIsImtleWdlbiIsImxpbmUiLCJsaW5rIiwibWV0YSIsInBhcmFtIiwicGF0aCIsInBvbHlnb24iLCJwb2x5bGluZSIsInJlY3QiLCJzb3VyY2UiLCJzdG9wIiwidHJhY2siLCJ1c2UiLCJ3YnIiLCJQYXJzZXIiLCJjYnMiLCJjYWxsYmFjayIsIl9jYnMiLCJfY2FsbGJhY2siLCJfdGFnbmFtZSIsIl9hdHRyaWJuYW1lIiwiX2F0dHJpYnZhbHVlIiwiX2F0dHJpYnMiLCJfc3RhY2siLCJfdG9rZW5pemVyIiwicHJvdG90eXBlIiwib250ZXh0IiwiZGF0YSIsIm9ub3BlbnRhZ25hbWUiLCJ0b0xvd2VyQ2FzZSIsInB1c2giLCJvbm9wZW50YWdlbmQiLCJvbm9wZW50YWciLCJvbmNsb3NldGFnIiwibGVuZ3RoIiwicG9zIiwibGFzdEluZGV4T2YiLCJwb3AiLCJfY2xvc2VDdXJyZW50VGFnIiwib25hdHRyaWJlbmQiLCJyZXBsYWNlIiwib25lbmQiLCJpIiwibm9kZXMiLCJ0aXRsZSIsImltZ0xpc3QiLCJ3cml0ZSIsImNodW5rIiwicGFyc2UiLCJodG1sMm5vZGVzIiwidGFnU3R5bGUiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImFyZ3VtZW50cyIsImhhbmRsZXIiLCJyZXMiLCJlcnIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0EsSUFBTUEsWUFBWUMsUUFBUSxnQkFBUixDQUFsQjtBQUNBLElBQU1DLGFBQWFELFFBQVEsaUJBQVIsQ0FBbkI7QUFDQSxJQUFNRSxhQUFhO0FBQ2pCQyxTQUFPLElBRFU7QUFFakJDLE9BQUssSUFGWTtBQUdqQkMsVUFBUSxJQUhTO0FBSWpCQyxZQUFVLElBSk87QUFLakJDLFNBQU8sSUFMVTtBQU1qQkMsU0FBTyxJQU5VO0FBT2pCQyxXQUFTLElBUFE7QUFRakJDLFlBQVUsSUFSTztBQVNqQixjQUFZLElBVEs7QUFVakJDLE9BQUssSUFWWTtBQVdqQkMsUUFBTSxJQVhXO0FBWWpCQyxVQUFRLElBWlM7QUFhakJDLFFBQU0sSUFiVztBQWNqQkMsTUFBSSxJQWRhO0FBZWpCQyxVQUFRLElBZlM7QUFnQmpCQyxRQUFNLElBaEJXO0FBaUJqQkMsU0FBTyxJQWpCVTtBQWtCakJDLFFBQU0sSUFsQlc7QUFtQmpCQyxVQUFRLElBbkJTO0FBb0JqQkMsV0FBUyxJQXBCUTtBQXFCakJDLFFBQU0sSUFyQlc7QUFzQmpCQyxRQUFNLElBdEJXO0FBdUJqQkMsT0FBSyxJQXZCWTtBQXdCakJDLFNBQU8sSUF4QlU7QUF5QmpCQyxTQUFPLElBekJVO0FBMEJqQkMsUUFBTSxJQTFCVztBQTJCakJDLFNBQU87QUEzQlUsQ0FBbkI7QUE2QkEsSUFBTUMsVUFBVTtBQUNkQyxRQUFNLElBRFE7QUFFZEMsUUFBTSxJQUZRO0FBR2RDLFlBQVUsSUFISTtBQUlkQyxNQUFJLElBSlU7QUFLZEMsT0FBSyxJQUxTO0FBTWRDLFVBQVEsSUFOTTtBQU9kQyxXQUFTLElBUEs7QUFRZEMsV0FBUyxJQVJLO0FBU2RDLFNBQU8sSUFUTztBQVVkQyxTQUFPLElBVk87QUFXZEMsTUFBSSxJQVhVO0FBWWRDLE9BQUssSUFaUztBQWFkQyxTQUFPLElBYk87QUFjZEMsV0FBUyxJQWRLO0FBZWRDLFVBQVEsSUFmTTtBQWdCZEMsUUFBTSxJQWhCUTtBQWlCZEMsUUFBTSxJQWpCUTtBQWtCZEMsUUFBTSxJQWxCUTtBQW1CZEMsU0FBTyxJQW5CTztBQW9CZEMsUUFBTSxJQXBCUTtBQXFCZEMsV0FBUyxJQXJCSztBQXNCZEMsWUFBVSxJQXRCSTtBQXVCZEMsUUFBTSxJQXZCUTtBQXdCZEMsVUFBUSxJQXhCTTtBQXlCZEMsUUFBTSxJQXpCUTtBQTBCZEMsU0FBTyxJQTFCTztBQTJCZEMsT0FBSyxJQTNCUztBQTRCZEMsT0FBSztBQTVCUyxDQUFoQjs7QUErQkEsU0FBU0MsTUFBVCxDQUFnQkMsR0FBaEIsRUFBcUJDLFFBQXJCLEVBQStCO0FBQzdCLE9BQUtDLElBQUwsR0FBWUYsR0FBWjtBQUNBLE9BQUtHLFNBQUwsR0FBaUJGLFFBQWpCO0FBQ0EsT0FBS0csUUFBTCxHQUFnQixFQUFoQjtBQUNBLE9BQUtDLFdBQUwsR0FBbUIsRUFBbkI7QUFDQSxPQUFLQyxZQUFMLEdBQW9CLEVBQXBCO0FBQ0EsT0FBS0MsUUFBTCxHQUFnQixJQUFoQjtBQUNBLE9BQUtDLE1BQUwsR0FBYyxFQUFkO0FBQ0EsT0FBS0MsVUFBTCxHQUFrQixJQUFJckUsU0FBSixDQUFjLElBQWQsQ0FBbEI7QUFDRDtBQUNEMkQsT0FBT1csU0FBUCxDQUFpQkMsTUFBakIsR0FBMEIsVUFBU0MsSUFBVCxFQUFlO0FBQ3ZDLE9BQUtWLElBQUwsQ0FBVVMsTUFBVixDQUFpQkMsSUFBakI7QUFDRCxDQUZEO0FBR0FiLE9BQU9XLFNBQVAsQ0FBaUJHLGFBQWpCLEdBQWlDLFVBQVNyRCxJQUFULEVBQWU7QUFDOUNBLFNBQU9BLEtBQUtzRCxXQUFMLEVBQVA7QUFDQSxPQUFLVixRQUFMLEdBQWdCNUMsSUFBaEI7QUFDQSxPQUFLK0MsUUFBTCxHQUFnQjtBQUNkeEMsV0FBTztBQURPLEdBQWhCO0FBR0EsTUFBSSxDQUFDRyxRQUFRVixJQUFSLENBQUwsRUFBb0IsS0FBS2dELE1BQUwsQ0FBWU8sSUFBWixDQUFpQnZELElBQWpCO0FBQ3JCLENBUEQ7QUFRQXVDLE9BQU9XLFNBQVAsQ0FBaUJNLFlBQWpCLEdBQWdDLFlBQVc7QUFDekMsTUFBSSxLQUFLVCxRQUFULEVBQW1CO0FBQ2pCLFNBQUtMLElBQUwsQ0FBVWUsU0FBVixDQUFvQixLQUFLYixRQUF6QixFQUFtQyxLQUFLRyxRQUF4QztBQUNBLFNBQUtBLFFBQUwsR0FBZ0IsSUFBaEI7QUFDRDtBQUNELE1BQUlyQyxRQUFRLEtBQUtrQyxRQUFiLENBQUosRUFBNEIsS0FBS0YsSUFBTCxDQUFVZ0IsVUFBVixDQUFxQixLQUFLZCxRQUExQjtBQUM1QixPQUFLQSxRQUFMLEdBQWdCLEVBQWhCO0FBQ0QsQ0FQRDtBQVFBTCxPQUFPVyxTQUFQLENBQWlCUSxVQUFqQixHQUE4QixVQUFTMUQsSUFBVCxFQUFlO0FBQzNDQSxTQUFPQSxLQUFLc0QsV0FBTCxFQUFQO0FBQ0EsTUFBSSxLQUFLTixNQUFMLENBQVlXLE1BQVosSUFBc0IsQ0FBQ2pELFFBQVFWLElBQVIsQ0FBM0IsRUFBMEM7QUFDeEMsUUFBSTRELE1BQU0sS0FBS1osTUFBTCxDQUFZYSxXQUFaLENBQXdCN0QsSUFBeEIsQ0FBVjtBQUNBLFFBQUk0RCxRQUFRLENBQUMsQ0FBYixFQUFnQjtBQUNkQSxZQUFNLEtBQUtaLE1BQUwsQ0FBWVcsTUFBWixHQUFxQkMsR0FBM0I7QUFDQSxhQUFPQSxLQUFQO0FBQWMsYUFBS2xCLElBQUwsQ0FBVWdCLFVBQVYsQ0FBcUIsS0FBS1YsTUFBTCxDQUFZYyxHQUFaLEVBQXJCO0FBQWQ7QUFDRCxLQUhELE1BR08sSUFBSTlELFNBQVMsR0FBYixFQUFrQjtBQUN2QixXQUFLcUQsYUFBTCxDQUFtQnJELElBQW5CO0FBQ0EsV0FBSytELGdCQUFMO0FBQ0Q7QUFDRixHQVRELE1BU08sSUFBSS9ELFNBQVMsSUFBVCxJQUFpQkEsU0FBUyxJQUExQixJQUFrQ0EsU0FBUyxHQUEvQyxFQUFvRDtBQUN6RCxTQUFLcUQsYUFBTCxDQUFtQnJELElBQW5CO0FBQ0EsU0FBSytELGdCQUFMO0FBQ0Q7QUFDRixDQWZEO0FBZ0JBeEIsT0FBT1csU0FBUCxDQUFpQmEsZ0JBQWpCLEdBQW9DLFlBQVc7QUFDN0MsTUFBSS9ELE9BQU8sS0FBSzRDLFFBQWhCO0FBQ0EsT0FBS1ksWUFBTDtBQUNBLE1BQUksS0FBS1IsTUFBTCxDQUFZLEtBQUtBLE1BQUwsQ0FBWVcsTUFBWixHQUFxQixDQUFqQyxNQUF3QzNELElBQTVDLEVBQWtEO0FBQ2hELFNBQUswQyxJQUFMLENBQVVnQixVQUFWLENBQXFCMUQsSUFBckI7QUFDQSxTQUFLZ0QsTUFBTCxDQUFZYyxHQUFaO0FBQ0Q7QUFDRixDQVBEO0FBUUF2QixPQUFPVyxTQUFQLENBQWlCYyxXQUFqQixHQUErQixZQUFXO0FBQ3hDLE9BQUtsQixZQUFMLEdBQW9CLEtBQUtBLFlBQUwsQ0FBa0JtQixPQUFsQixDQUEwQixTQUExQixFQUFxQyxHQUFyQyxDQUFwQjtBQUNBLE1BQUksS0FBS2xCLFFBQUwsSUFBaUJoRSxXQUFXLEtBQUs4RCxXQUFoQixDQUFyQixFQUFtRDtBQUNqRCxTQUFLRSxRQUFMLENBQWMsS0FBS0YsV0FBbkIsSUFBa0MsS0FBS0MsWUFBdkM7QUFDRDtBQUNELE9BQUtELFdBQUwsR0FBbUIsRUFBbkI7QUFDQSxPQUFLQyxZQUFMLEdBQW9CLEVBQXBCO0FBQ0QsQ0FQRDtBQVFBUCxPQUFPVyxTQUFQLENBQWlCZ0IsS0FBakIsR0FBeUIsWUFBVztBQUNsQyxPQUNFLElBQUlDLElBQUksS0FBS25CLE1BQUwsQ0FBWVcsTUFEdEIsRUFDOEJRLElBQUksQ0FEbEMsRUFDcUMsS0FBS3pCLElBQUwsQ0FBVWdCLFVBQVYsQ0FBcUIsS0FBS1YsTUFBTCxDQUFZLEVBQUVtQixDQUFkLENBQXJCLENBRHJDO0FBR0EsT0FBS3hCLFNBQUwsQ0FBZTtBQUNiLGFBQVMsS0FBS0QsSUFBTCxDQUFVMEIsS0FETjtBQUViLGFBQVMsS0FBSzFCLElBQUwsQ0FBVTJCLEtBRk47QUFHYixlQUFXLEtBQUszQixJQUFMLENBQVU0QjtBQUhSLEdBQWY7QUFLRCxDQVREO0FBVUEvQixPQUFPVyxTQUFQLENBQWlCcUIsS0FBakIsR0FBeUIsVUFBU0MsS0FBVCxFQUFnQjtBQUN2QyxPQUFLdkIsVUFBTCxDQUFnQndCLEtBQWhCLENBQXNCRCxLQUF0QjtBQUNELENBRkQ7O0FBSUEsU0FBU0UsVUFBVCxDQUFvQnRCLElBQXBCLEVBQTBCdUIsUUFBMUIsRUFBb0M7QUFDbEMsU0FBTyxJQUFJQyxPQUFKLENBQVksVUFBU0MsT0FBVCxFQUFrQkMsTUFBbEIsRUFBMEI7QUFDM0MsUUFBSTtBQUNGLFVBQUl2RSxRQUFRLEVBQVo7QUFDQTZDLGFBQU9BLEtBQUthLE9BQUwsQ0FBYSxpQ0FBYixFQUFnRCxZQUFXO0FBQ2hFMUQsaUJBQVN3RSxVQUFVLENBQVYsQ0FBVDtBQUNBLGVBQU8sRUFBUDtBQUNELE9BSE0sQ0FBUDtBQUlBLFVBQUlDLFVBQVUsSUFBSWxHLFVBQUosQ0FBZXlCLEtBQWYsRUFBc0JvRSxRQUF0QixDQUFkO0FBQ0EsVUFBSXBDLE1BQUosQ0FBV3lDLE9BQVgsRUFBb0IsVUFBQ0MsR0FBRCxFQUFTO0FBQzNCLGVBQU9KLFFBQVFJLEdBQVIsQ0FBUDtBQUNELE9BRkQsRUFFR1YsS0FGSCxDQUVTbkIsSUFGVDtBQUdELEtBVkQsQ0FVRSxPQUFPOEIsR0FBUCxFQUFZO0FBQ1osYUFBT0osT0FBT0ksR0FBUCxDQUFQO0FBQ0Q7QUFDRixHQWRNLENBQVA7QUFlRDtBQUNEQyxPQUFPQyxPQUFQLEdBQWlCVixVQUFqQiIsImZpbGUiOiJQYXJzZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvL1BhcnNlci5qc1xuY29uc3QgVG9rZW5pemVyID0gcmVxdWlyZShcIi4vVG9rZW5pemVyLmpzXCIpO1xuY29uc3QgRG9tSGFuZGxlciA9IHJlcXVpcmUoXCIuL0RvbUhhbmRsZXIuanNcIik7XG5jb25zdCB0cnVzdEF0dHJzID0ge1xuICBhbGlnbjogdHJ1ZSxcbiAgYWx0OiB0cnVlLFxuICBhdXRob3I6IHRydWUsXG4gIGF1dG9wbGF5OiB0cnVlLFxuICBjbGFzczogdHJ1ZSxcbiAgY29sb3I6IHRydWUsXG4gIGNvbHNwYW46IHRydWUsXG4gIGNvbnRyb2xzOiB0cnVlLFxuICBcImRhdGEtc3JjXCI6IHRydWUsXG4gIGRpcjogdHJ1ZSxcbiAgZmFjZTogdHJ1ZSxcbiAgaGVpZ2h0OiB0cnVlLFxuICBocmVmOiB0cnVlLFxuICBpZDogdHJ1ZSxcbiAgaWdub3JlOiB0cnVlLFxuICBsb29wOiB0cnVlLFxuICBtdXRlZDogdHJ1ZSxcbiAgbmFtZTogdHJ1ZSxcbiAgcG9zdGVyOiB0cnVlLFxuICByb3dzcGFuOiB0cnVlLFxuICBzaXplOiB0cnVlLFxuICBzcGFuOiB0cnVlLFxuICBzcmM6IHRydWUsXG4gIHN0YXJ0OiB0cnVlLFxuICBzdHlsZTogdHJ1ZSxcbiAgdHlwZTogdHJ1ZSxcbiAgd2lkdGg6IHRydWUsXG59O1xuY29uc3Qgdm9pZFRhZyA9IHtcbiAgYXJlYTogdHJ1ZSxcbiAgYmFzZTogdHJ1ZSxcbiAgYmFzZWZvbnQ6IHRydWUsXG4gIGJyOiB0cnVlLFxuICBjb2w6IHRydWUsXG4gIGNpcmNsZTogdHJ1ZSxcbiAgY29tbWFuZDogdHJ1ZSxcbiAgZWxsaXBzZTogdHJ1ZSxcbiAgZW1iZWQ6IHRydWUsXG4gIGZyYW1lOiB0cnVlLFxuICBocjogdHJ1ZSxcbiAgaW1nOiB0cnVlLFxuICBpbnB1dDogdHJ1ZSxcbiAgaXNpbmRleDogdHJ1ZSxcbiAga2V5Z2VuOiB0cnVlLFxuICBsaW5lOiB0cnVlLFxuICBsaW5rOiB0cnVlLFxuICBtZXRhOiB0cnVlLFxuICBwYXJhbTogdHJ1ZSxcbiAgcGF0aDogdHJ1ZSxcbiAgcG9seWdvbjogdHJ1ZSxcbiAgcG9seWxpbmU6IHRydWUsXG4gIHJlY3Q6IHRydWUsXG4gIHNvdXJjZTogdHJ1ZSxcbiAgc3RvcDogdHJ1ZSxcbiAgdHJhY2s6IHRydWUsXG4gIHVzZTogdHJ1ZSxcbiAgd2JyOiB0cnVlXG59O1xuXG5mdW5jdGlvbiBQYXJzZXIoY2JzLCBjYWxsYmFjaykge1xuICB0aGlzLl9jYnMgPSBjYnM7XG4gIHRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2s7XG4gIHRoaXMuX3RhZ25hbWUgPSBcIlwiO1xuICB0aGlzLl9hdHRyaWJuYW1lID0gXCJcIjtcbiAgdGhpcy5fYXR0cmlidmFsdWUgPSBcIlwiO1xuICB0aGlzLl9hdHRyaWJzID0gbnVsbDtcbiAgdGhpcy5fc3RhY2sgPSBbXTtcbiAgdGhpcy5fdG9rZW5pemVyID0gbmV3IFRva2VuaXplcih0aGlzKTtcbn1cblBhcnNlci5wcm90b3R5cGUub250ZXh0ID0gZnVuY3Rpb24oZGF0YSkge1xuICB0aGlzLl9jYnMub250ZXh0KGRhdGEpO1xufTtcblBhcnNlci5wcm90b3R5cGUub25vcGVudGFnbmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTtcbiAgdGhpcy5fdGFnbmFtZSA9IG5hbWU7XG4gIHRoaXMuX2F0dHJpYnMgPSB7XG4gICAgc3R5bGU6ICcnXG4gIH07XG4gIGlmICghdm9pZFRhZ1tuYW1lXSkgdGhpcy5fc3RhY2sucHVzaChuYW1lKTtcbn07XG5QYXJzZXIucHJvdG90eXBlLm9ub3BlbnRhZ2VuZCA9IGZ1bmN0aW9uKCkge1xuICBpZiAodGhpcy5fYXR0cmlicykge1xuICAgIHRoaXMuX2Nicy5vbm9wZW50YWcodGhpcy5fdGFnbmFtZSwgdGhpcy5fYXR0cmlicyk7XG4gICAgdGhpcy5fYXR0cmlicyA9IG51bGw7XG4gIH1cbiAgaWYgKHZvaWRUYWdbdGhpcy5fdGFnbmFtZV0pIHRoaXMuX2Nicy5vbmNsb3NldGFnKHRoaXMuX3RhZ25hbWUpO1xuICB0aGlzLl90YWduYW1lID0gXCJcIjtcbn07XG5QYXJzZXIucHJvdG90eXBlLm9uY2xvc2V0YWcgPSBmdW5jdGlvbihuYW1lKSB7XG4gIG5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7XG4gIGlmICh0aGlzLl9zdGFjay5sZW5ndGggJiYgIXZvaWRUYWdbbmFtZV0pIHtcbiAgICB2YXIgcG9zID0gdGhpcy5fc3RhY2subGFzdEluZGV4T2YobmFtZSk7XG4gICAgaWYgKHBvcyAhPT0gLTEpIHtcbiAgICAgIHBvcyA9IHRoaXMuX3N0YWNrLmxlbmd0aCAtIHBvcztcbiAgICAgIHdoaWxlIChwb3MtLSkgdGhpcy5fY2JzLm9uY2xvc2V0YWcodGhpcy5fc3RhY2sucG9wKCkpO1xuICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gXCJwXCIpIHtcbiAgICAgIHRoaXMub25vcGVudGFnbmFtZShuYW1lKTtcbiAgICAgIHRoaXMuX2Nsb3NlQ3VycmVudFRhZygpO1xuICAgIH1cbiAgfSBlbHNlIGlmIChuYW1lID09PSBcImJyXCIgfHwgbmFtZSA9PT0gXCJoclwiIHx8IG5hbWUgPT09IFwicFwiKSB7XG4gICAgdGhpcy5vbm9wZW50YWduYW1lKG5hbWUpO1xuICAgIHRoaXMuX2Nsb3NlQ3VycmVudFRhZygpO1xuICB9XG59O1xuUGFyc2VyLnByb3RvdHlwZS5fY2xvc2VDdXJyZW50VGFnID0gZnVuY3Rpb24oKSB7XG4gIGxldCBuYW1lID0gdGhpcy5fdGFnbmFtZTtcbiAgdGhpcy5vbm9wZW50YWdlbmQoKTtcbiAgaWYgKHRoaXMuX3N0YWNrW3RoaXMuX3N0YWNrLmxlbmd0aCAtIDFdID09PSBuYW1lKSB7XG4gICAgdGhpcy5fY2JzLm9uY2xvc2V0YWcobmFtZSk7XG4gICAgdGhpcy5fc3RhY2sucG9wKCk7XG4gIH1cbn07XG5QYXJzZXIucHJvdG90eXBlLm9uYXR0cmliZW5kID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMuX2F0dHJpYnZhbHVlID0gdGhpcy5fYXR0cmlidmFsdWUucmVwbGFjZSgvJnF1b3Q7L2csICdcIicpO1xuICBpZiAodGhpcy5fYXR0cmlicyAmJiB0cnVzdEF0dHJzW3RoaXMuX2F0dHJpYm5hbWVdKSB7XG4gICAgdGhpcy5fYXR0cmlic1t0aGlzLl9hdHRyaWJuYW1lXSA9IHRoaXMuX2F0dHJpYnZhbHVlO1xuICB9XG4gIHRoaXMuX2F0dHJpYm5hbWUgPSBcIlwiO1xuICB0aGlzLl9hdHRyaWJ2YWx1ZSA9IFwiXCI7XG59O1xuUGFyc2VyLnByb3RvdHlwZS5vbmVuZCA9IGZ1bmN0aW9uKCkge1xuICBmb3IgKFxuICAgIHZhciBpID0gdGhpcy5fc3RhY2subGVuZ3RoOyBpID4gMDsgdGhpcy5fY2JzLm9uY2xvc2V0YWcodGhpcy5fc3RhY2tbLS1pXSlcbiAgKTtcbiAgdGhpcy5fY2FsbGJhY2soe1xuICAgICdub2Rlcyc6IHRoaXMuX2Nicy5ub2RlcyxcbiAgICAndGl0bGUnOiB0aGlzLl9jYnMudGl0bGUsXG4gICAgJ2ltZ0xpc3QnOiB0aGlzLl9jYnMuaW1nTGlzdFxuICB9KTtcbn07XG5QYXJzZXIucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24oY2h1bmspIHtcbiAgdGhpcy5fdG9rZW5pemVyLnBhcnNlKGNodW5rKTtcbn07XG5cbmZ1bmN0aW9uIGh0bWwybm9kZXMoZGF0YSwgdGFnU3R5bGUpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgIHRyeSB7XG4gICAgICBsZXQgc3R5bGUgPSAnJztcbiAgICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UoLzxzdHlsZS4qPz4oW1xcc1xcU10qPyk8XFwvc3R5bGU+L2dpLCBmdW5jdGlvbigpIHtcbiAgICAgICAgc3R5bGUgKz0gYXJndW1lbnRzWzFdO1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgICB9KTtcbiAgICAgIGxldCBoYW5kbGVyID0gbmV3IERvbUhhbmRsZXIoc3R5bGUsIHRhZ1N0eWxlKTtcbiAgICAgIG5ldyBQYXJzZXIoaGFuZGxlciwgKHJlcykgPT4ge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZShyZXMpO1xuICAgICAgfSkud3JpdGUoZGF0YSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgfVxuICB9KVxufVxubW9kdWxlLmV4cG9ydHMgPSBodG1sMm5vZGVzOyJdfQ==